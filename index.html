<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width" />

    <title>APODEX : Astronomy Picture Of the Day indEX</title>

    <!-- <link rel="stylesheet" href="style.css"> -->
  </head>

  <body>
    <style>
      .video-responsive {
        overflow: hidden;
        /* screen-ratio 19:9 = 56,25% */
        padding-bottom: 56.25%;
        position: relative;
        height: 0;
      }

      .video-responsive iframe {
        left: 0;
        top: 0;
        height: 100%;
        width: 100%;
        position: absolute;
      }
    </style>
    <h1>APODEX : Astronomy Picture Of the Day indEX</h1>

    <label for="date">Choose a date:</label>

    <!-- drop down list for choosing the day -->
    <p>JOUR</p>
    <select id="selectDay" name="day"></select>

    <!-- drop down list for choosing the month -->
    <p>MOIS</p>
    <select id="selectMonth" name="month">
      <option value="1">janvier</option>
      <option value="2">février</option>
      <option value="3">mars</option>
      <option value="4">avril</option>
      <option value="5">mai</option>
      <option value="6" selected>juin</option>
      <option value="7">juillet</option>
      <option value="8">août</option>
      <option value="9">septembre</option>
      <option value="10">octobre</option>
      <option value="11">novembre</option>
      <option value="12">décembre</option>
    </select>

    <!-- drop down list for choosing the year -->
    <p>ANNEE</p>
    <select id="selectYear" name="year"></select>

    <button onclick="gettingDate()">Valider</button>
    <button onclick="previous()">Précédent</button>
    <button onclick="next()">Suivant</button>

    <p id="showDate"></p>
    <p id="showDateError"></p>

    <ul>
      <li id="media"></li>
      <li id="copyright"></li>
      <li id="date"></li>
      <li id="title"></li>
      <li id="explanation"></li>
    </ul>
  </body>
  <script>
    //given by nasa after registration on https://api.nasa.gov/
    let key = "jdXTBjcvZ9yrTeVVvfAa1U6zukOXiPgOaZOZn0vx";

    //defining date of today (in fact today minus 1 day, because of time difference between France and the US,
    //we assume we can only have image of yesterday whatever the hour in France.
    let currentDate = new Date(Date.parse(new Date()) - 86400000);

    //extracting year, month and day of today
    let currentYear = currentDate.getFullYear();

    //in new Date, January = 0, December = 11. After : January = 1, December = 12
    let currentMonth = currentDate.getMonth() + 1;
    let currentDay = currentDate.getDate();

    //string variables will be used to pass information about picture wanted by date to the API.
    // 01 stands for January, 12 stands for December. At first they are initialised with the date of today
    let day = currentDay.toString();
    if (day.length == 1) {
      day = "0" + day;
    }

    let month = currentMonth.toString();
    if (month.length == 1) {
      month = "0" + month;
    }

    let year = currentYear.toString();

    let dayUser, monthUser, yearUser, dateUser;

    let dateToDisplay;

    //initializing dateUser with the current date
    dateUser = new Date(`${year}-${month}-${day}`);
    console.log("date user " + dateUser);

    //variable who allows or not the view of data given by API, (error type) 0 means OK, (error type) 1 means date prior to 16th June 1995, (error type) 2 means date posterior to today, (error type) 3 means the date doesn't exist
    let dateError = 0;

    //generating values for displaying drop-down list of days
    for (let i = 1; i < 32; i++) {
      document.getElementById(
        "selectDay"
      ).innerHTML += `<option value="${i}">${i}</option>`;
    }

    //generating values for displaying drop-down list of years
    for (let i = 1995; i < currentYear + 1; i++) {
      document.getElementById(
        "selectYear"
      ).innerHTML += `<option value="${i}">${i}</option>`;
    }

    //at loading page, launch the picture of the day (in fact, picture of yesterday, because of jet lag between France and US where )
    displayInfo(year, month, day);

    function previous() {
      //dateUser is set to previous day (8 640 000 ms = 24 hours)
      dateUser = new Date(Date.parse(dateUser) - 86400000);

      day = dateUser.getDate().toString();
      if (day.length == 1) {
        day = "0" + day;
      }

      month = (dateUser.getMonth() + 1).toString();
      if (month.length == 1) {
        month = "0" + month;
      }

      year = dateUser.getFullYear().toString();

      // date can't be anterior to 16th of June 1995
      if (year == "1995" && month == "06" && day == "15") {
        year = "1995";
        month = "06";
        day == "16";
      }

      displayInfo(year, month, day);
    }

    function next() {
      //dateUser is set to the next day (8 640 000 ms = 24 hours)
      dateUser = new Date(Date.parse(dateUser) + 86400000);

      //testing if date is next day to today
      if (
        dateUser.getFullYear() == currentYear &&
        dateUser.getMonth() + 1 == currentMonth &&
        dateUser.getDate() == currentDay + 1
      ) {
        //in this case setting back the date to today
        dateUser = new Date(Date.parse(dateUser) - 86400000);
      }

      //extracting day from dateUser et transforming into a 2-characters string
      day = dateUser.getDate().toString();
      if (day.length == 1) {
        day = "0" + day;
      }

      //extracting month from dateUser et transforming into a 2-characters string
      month = (dateUser.getMonth() + 1).toString();
      if (month.length == 1) {
        month = "0" + month;
      }

      //extracting year from dateUser et transforming into a string
      year = dateUser.getFullYear().toString();

      displayInfo(year, month, day);
    }

    function gettingDate() {
      // getting day given by user, day is transformed in a string being used by the URL of the API
      dayUser = document.getElementById("selectDay").value;
      // day = dayUser.toString();
      day = dayUser;
      //testing and formatting day with 2 digits, e.g. string must be 01 and not 1
      console.log(typeof day);
      console.log("day : " + day);
      if (day.length == 1) {
        day = "0" + day;
        console.log("day dans if : " + day);
      }

      // getting month given by user, month is transformed in a string being used by the URL of the API
      monthUser = document.getElementById("selectMonth").value;
      month = monthUser.toString();

      //testing and formatting month with 2 digits, e.g. string must be 01 and not 1
      if (month.length == 1) {
        month = "0" + month;
      }

      // getting year given by user, year is transformed in a string being used by the URL of the API
      yearUser = document.getElementById("selectYear").value;
      year = yearUser.toString();

      dateUser = new Date(`${year}-${month}-${day}`);
      console.log(`date : ${year}-${month}-${day}`);
      console.log("date au format iso : " + dateUser);

      //display the date in dd mm yyyy format
      document.getElementById(
        "showDate"
      ).innerHTML = `dateUser ${day} ${month} ${year}`;

      isValidDate();
      // console.log(dateError)
      displayInfo(year, month, day);
    }

    function isValidDate() {
      //initialize variable who allows or not the view of data given by API, (error type) 0 means OK, (error type) 1 means date anterior to 16th June 1995, (error type) 2 means date posterior to today, (error type) 3 means the date doesn't exist
      dateError = 0;

      //test the date, valid date must be equal or posterior to 16th June 1995 else error type 1
      if (
        (yearUser == 1995 && monthUser < 6) ||
        (yearUser == 1995 && monthUser == 6 && dayUser < 16)
      ) {
        dateError = 1;
      }

      //test the date, valid date must be prior to today else error type 2.
      if (
        yearUser > currentYear ||
        (yearUser == currentYear && monthUser > currentMonth) ||
        (yearUser == currentYear &&
          monthUser == currentMonth &&
          dayUser > currentDay)
      ) {
        dateError = 2;
      }

      //test the date, must exist. Excluding 31th of February, April, June, September and November else error type 3.
      if (
        dayUser == 31 &&
        (monthUser == 2 ||
          monthUser == 4 ||
          monthUser == 6 ||
          monthUser == 9 ||
          monthUser == 11)
      ) {
        dateError = 3;
      }

      //test the date, must exist. Excluding 30th of February else error type 3.
      if (dayUser == 30 && monthUser == 2) {
        dateError = 3;
      }

      //test the date, must exist. Excluding 29th of February of non leap year else error type 3.
      if (dayUser == 29 && monthUser == 2 && yearUser % 4 != 0) {
        dateError = 3;
      }
    }

    function displayInfo(year, month, day) {
      if (dateError == 0) {
        //erase error message about invalid date
        document.getElementById("showDateError").innerHTML = ``;

        //get data from NASA API with date in format YYYY-MM-DD
        fetch(
          `https://api.nasa.gov/planetary/apod?api_key=${key}&date=${year}-${month}-${day}`
        )
          .then(function (response) {
            if (!response.ok) {
              throw new Error("HTTP error, status = " + response.status);
              document.getElementById(
                "showDateError"
              ).innerHTML = `Il n'y a pas de média pour cette date`;
            }
            return response.json();
          })

          //display data
          .then(function (json) {
            //display name of the author only if copyright exists
            if (json.copyright != undefined) {
              document.getElementById("copyright").innerHTML = json.copyright;
            }

            //display date of the media
            document.getElementById("date").innerHTML = json.date;

            //display explanation of the media
            document.getElementById("explanation").innerHTML = json.explanation;

            //display title of the media
            document.getElementById("title").innerHTML = json.title;

            //test the type of media and display video or image
            if (json.media_type == "video") {
              document.getElementById(
                "media"
              ).innerHTML = ` <div class="video-responsive">
                                <iframe src="${json.url}"
                                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                                <p>Votre navigateur ne prend pas en charge les vidéos HTML5.
                                Voici <a href="${json.url}">un lien pour télécharger la vidéo</a>.
                                </p>
                                </iframe>
                              </div>`;
            } else {
              document.getElementById(
                "media"
              ).innerHTML = `<img src="${json.url}" width="100%" alt="${json.title}">`;
            }
          })
          .catch(function (error) {
            var p = document.createElement("p");
            p.appendChild(document.createTextNode("Error: " + error.message));
            document.body.insertBefore(p);
          });
      }

      //in case of invalid date, erase previous displayed data and show error message
      else {
        switch (dateError) {
          //show error message, date must be equal or posterior to 16th June 1995.
          case 1:
            document.getElementById(
              "showDateError"
            ).innerHTML = `La date doit être égale ou postérieure au 16 juin 1995.`;
            break;

          //show error message, date must be prior to today.
          case 2:
            document.getElementById(
              "showDateError"
            ).innerHTML = `La date doit être antérieure à aujourd'hui.`;
            break;

          //show error message, date must exist
          case 3:
            document.getElementById(
              "showDateError"
            ).innerHTML = `Cette date n'existe pas.`;
            break;

          default:
            document.getElementById(
              "showDateError"
            ).innerHTML = `Il n'a pas de media pour cette date`;
        }

        //erase previous displayed data
        document.getElementById("copyright").innerHTML = " ";
        document.getElementById("date").innerHTML = " ";
        document.getElementById("explanation").innerHTML = " ";
        document.getElementById("title").innerHTML = " ";
        document.getElementById("url").innerHTML = " ";
      }
    }
  </script>
</html>
